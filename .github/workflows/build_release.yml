name: Build Release
run-name: Build Release by ${{ github.actor }}
on: 
  release:
    types: [ published ]
  push:
    branches: [ qt6.8 ] 
jobs:
  build-linux:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
    strategy:
      matrix:
        include:
          - { arch: x86_64, profile: x64 }
          - { arch: aarch64, profile: arm64 }
          - { arch: armhf, profile: armv7l }
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: prepare build environment
        if: ${{ matrix.arch == 'x86_64' }}
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo apt install -y git curl zip unzip tar gcc g++ make pkg-config python3 python3-jinja2 autoconf automake libtool '^libxcb.*-dev' libx11-xcb-dev libglu1-mesa-dev libxrender-dev libxi-dev libxkbcommon-dev libxkbcommon-x11-dev libegl1-mesa-dev libwayland-dev ninja-build pipx strace patchelf fakeroot squashfs-tools zsync xserver-xorg-core
          pipx ensurepath && source ~/.bashrc
          pipx install cmake 
          pipx install git+https://github.com/AppImageCrafters/appimage-builder.git

      - name: prepare build environment
        if: ${{ matrix.arch == 'aarch64' }}
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo dpkg --add-architecture arm64
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy main restricted" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy-updates main restricted" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy universe" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy-updates universe" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy-updates multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy-backports main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy-security main restricted" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy-security universe" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy-security multiverse" | sudo tee -a /etc/apt/sources.list
          sudo apt update
          sudo apt install -y git curl zip unzip tar gcc g++ gcc-aarch64-linux-gnu g++-aarch64-linux-gnu make pkg-config python3 python3-jinja2 autoconf automake libtool '^libxcb.*-dev':arm64 libx11-xcb-dev:arm64 libglu1-mesa-dev:arm64 libxrender-dev:arm64 libxi-dev:arm64 libxkbcommon-dev:arm64 libxkbcommon-x11-dev:arm64 libegl1-mesa-dev:arm64 libwayland-dev:arm64 '^libxcb.*-dev' libx11-xcb-dev libglu1-mesa-dev libxrender-dev libxi-dev libxkbcommon-dev libxkbcommon-x11-dev libegl1-mesa-dev libwayland-dev bison flex autoconf-archive ninja-build pipx strace patchelf fakeroot squashfs-tools zsync xserver-xorg-core:arm64
          pipx ensurepath && source ~/.bashrc
          pipx install cmake 
          pipx install git+https://github.com/AppImageCrafters/appimage-builder.git

      - name: prepare build environment
        if: ${{ matrix.arch == 'armhf' }}
        run: |
          sudo apt update && sudo apt upgrade -y
          sudo dpkg --add-architecture armhf
          echo "deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports/ jammy main restricted" | sudo tee /etc/apt/sources.list
          echo "deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports/ jammy-updates main restricted" | sudo tee /etc/apt/sources.list
          echo "deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports/ jammy universe" | sudo tee /etc/apt/sources.list
          echo "deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports/ jammy-updates universe" | sudo tee /etc/apt/sources.list
          echo "deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports/ jammy multiverse" | sudo tee /etc/apt/sources.list
          echo "deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports/ jammy-updates multiverse" | sudo tee /etc/apt/sources.list
          echo "deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports/ jammy-backports main restricted universe multiverse" | sudo tee /etc/apt/sources.list
          echo "deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports/ jammy-security main restricted" | sudo tee /etc/apt/sources.list
          echo "deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports/ jammy-security universe" | sudo tee /etc/apt/sources.list
          echo "deb [arch=armhf] http://ports.ubuntu.com/ubuntu-ports/ jammy-security multiverse" | sudo tee /etc/apt/sources.list
          sudo apt update
          sudo apt install -y git curl zip unzip tar gcc g++ gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf make pkg-config python3 python3-jinja2 autoconf automake libtool '^libxcb.*-dev':armhf libx11-xcb-dev:armhf libglu1-mesa-dev:armhf libxrender-dev:armhf libxi-dev:armhf libxkbcommon-dev:armhf libxkbcommon-x11-dev:armhf libegl1-mesa-dev:armhf libwayland-dev:armhf '^libxcb.*-dev' libx11-xcb-dev libglu1-mesa-dev libxrender-dev libxi-dev libxkbcommon-dev libxkbcommon-x11-dev libegl1-mesa-dev libwayland-dev bison flex autoconf-archive ninja-build pipx strace patchelf fakeroot squashfs-tools zsync xserver-xorg-core:armhf
          pipx ensurepath && source ~/.bashrc
          pipx install cmake 
          pipx install git+https://github.com/AppImageCrafters/appimage-builder.git
        
      - name: build binary and appimage
        run: |
          cp ./.github/linux/CMakeUserPresets.json .
          cmake . --preset linux-${{ matrix.profile }}
          cmake --build . --target install --preset linux-${{ matrix.profile }}-release -j
          mv ./out/install/linux-${{ matrix.profile }}/bin/assfonts assfonts-${{ github.ref_name }}-${{ matrix.arch }}-Linux
          cp ./.github/linux/AppImageBuilder_${{ matrix.profile }}.yml AppImageBuilder.yml
          mkdir -p ./AppDir/usr
          cp -r ./out/install/linux-${{ matrix.profile }}/* ./AppDir/usr
          mkdir -p ./AppDir/usr/share/icons
          cp ./src/qt/resources/icon.png ./AppDir/usr/share/icons
          mkdir -p ./AppDir/usr/share/applications
          cp ./src/qt/resources/assfonts-gui.desktop ./AppDir/usr/share/applications
          sed -i 's/!!!VERSION!!!/${{ github.ref_name }}/g' AppImageBuilder.yml
          appimage-builder --recipe AppImageBuilder.yml --skip-tests

      - name: upload Linux
        uses: actions/upload-artifact@v4
        with:
          name: release-Linux-${{ matrix.arch }}
          path: assfonts*-${{ github.ref_name }}-${{ matrix.arch }}-Linux*
          if-no-files-found: error
          
      - name: upload issue
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.profile }}-issue
          path: out/build/linux-${{ matrix.profile }}/vcpkg_installed/vcpkg/issue_body.md

      - name: upload vcpkg error
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.profile }}-error
          path: vcpkg/buildtrees/detect_compiler/config-${{ matrix.profile }}-linux-release-rel-err.log

  build-windows:
    runs-on: windows-2022
    defaults:
      run:
        shell: powershell
    strategy:
      matrix:
        include:
          - { arch: x86_64, profile: x64 }
          - { arch: aarch64, profile: arm64 }
          - { arch: i686, profile: x86 }
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: install cmake
        uses: lukka/get-cmake@latest
        
      - name: setup msvc x86_64
        uses: TheMrMilchmann/setup-msvc-dev@v3
        if: ${{ matrix.arch == 'x86_64' }}
        with:
          arch: x64
          
      - name: setup msvc aarch64
        uses: TheMrMilchmann/setup-msvc-dev@v3
        if: ${{ matrix.arch == 'aarch64' }}
        with:
          arch: amd64_arm64

      - name: setup msvc i686
        uses: TheMrMilchmann/setup-msvc-dev@v3
        if: ${{ matrix.arch == 'i686' }}
        with:
          arch: amd64_x86

      - name: build executable binary
        run: |
          Copy-Item -Path ".\.github\windows\CMakeUserPresets.json" -Destination "CMakeUserPresets.json" -Force
          cmake . --preset windows-${{ matrix.profile }}
          cmake --build . --target install --preset windows-${{ matrix.profile }}-release -j

      - name: copy and rename
        run: |
           Copy-Item -Path ".\out\install\windows-${{ matrix.profile }}\bin\assfonts.exe" -Destination "assfonts-${{ github.ref_name }}-${{ matrix.arch }}-Windows.exe" -Force
           Copy-Item -Path ".\out\install\windows-${{ matrix.profile }}\bin\assfonts-gui.exe" -Destination "assfonts-gui-${{ github.ref_name }}-${{ matrix.arch }}-Windows.exe" -Force

      - name: upload Windows
        uses: actions/upload-artifact@v4
        with:
          name: release-Windows-${{ matrix.arch }}
          path: assfonts*-${{ github.ref_name }}-${{ matrix.arch }}-Windows*
          if-no-files-found: error
          
      - name: upload issue
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.profile }}-issue
          path: out/build/windows-${{ matrix.profile }}/vcpkg_installed/vcpkg/issue_body.md
          
  build-macos:
    runs-on: macos-14
    defaults:
      run:
        shell: bash
    strategy:
      matrix:
        include:
          - { arch: x86_64, profile: x64 }
          - { arch: aarch64, profile: arm64 }
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: install cmake
        uses: lukka/get-cmake@latest

      - name: build executable binary
        run: |
          brew install automake autoconf-archive libtool
          cp .github/macos/CMakeUserPresets.json .
          cmake . --preset macos-${{ matrix.profile }}
          cmake --build . --preset macos-${{ matrix.profile }}-release --target package -j

      - name: rename
        run: |
          mv -f assfonts.dmg assfonts-${{ github.ref_name }}-${{ matrix.arch }}-macOS.dmg

      - name: upload macOS
        uses: actions/upload-artifact@v4
        with:
          name: release-macOS-${{ matrix.arch }}
          path: assfonts-${{ github.ref_name }}-${{ matrix.arch }}-macOS.dmg
          if-no-files-found: error
          
      - name: upload issue
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.profile }}-issue
          path: out/build/macos-${{ matrix.profile }}/vcpkg_installed/vcpkg/issue_body.md
          
  release:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
    needs: [ build-linux, build-windows, build-macos ]
    if: github.event_name == 'release'
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: download Linux x86_64
        uses: actions/download-artifact@v4
        with:
          name: release-Linux-x86_64

      - name: download Linux aarch64
        uses: actions/download-artifact@v4
        with:
          name: release-Linux-aarch64

      - name: download Linux armhf
        uses: actions/download-artifact@v4
        with:
          name: release-Linux-armhf
          
      - name: download Linux i686
        uses: actions/download-artifact@v4
        with:
          name: release-Linux-i686

      - name: download Windows x86_64
        uses: actions/download-artifact@v4
        with:
          name: release-Windows-x86_64

      - name: download Windows aarch64
        uses: actions/download-artifact@v4
        with:
          name: release-Windows-aarch64

      - name: download Windows i686
        uses: actions/download-artifact@v4
        with:
          name: release-Windows-i686

      - name: download macOS x86_64
        uses: actions/download-artifact@v4
        with:
          name: release-macOS-x86_64

      - name: download macOS aarch64
        uses: actions/download-artifact@v4
        with:
          name: release-macOS-aarch64

      - name: create zips
        run: |
          sudo apt-get install -y zip
          mkdir -p ./share/doc/assfonts
          cp LICENSE LICENSE.txt
          cp NEWS NEWS.txt
          cp NOTICE NOTICE.txt
          cp LICENSE NEWS NOTICE ./share/doc/assfonts/
          mkdir -p ./share/man/man1
          gzip -k ./doc/man/assfonts.1
          cp ./doc/man/assfonts.1.gz ./share/man/man1/
          mkdir bin
          cp -f assfonts-${{ github.ref_name }}-x86_64-Linux ./bin/assfonts
          cp -f assfonts-gui-${{ github.ref_name }}-x86_64-Linux.AppImage assfonts-gui.AppImage
          tar -czvf assfonts-${{ github.ref_name }}-x86_64-Linux.tar.gz bin/assfonts assfonts-gui.AppImage ./share/doc/assfonts/LICENSE ./share/doc/assfonts/NEWS ./share/doc/assfonts/NOTICE ./share/man/man1/assfonts.1.gz
          rm -rf assfonts-${{ github.ref_name }}-x86_64-Linux assfonts-gui-${{ github.ref_name }}-x86_64-Linux.AppImage
          cp -f assfonts-${{ github.ref_name }}-aarch64-Linux ./bin/assfonts
          cp -f assfonts-gui-${{ github.ref_name }}-aarch64-Linux.AppImage assfonts-gui.AppImage
          tar -czvf assfonts-${{ github.ref_name }}-aarch64-Linux.tar.gz bin/assfonts assfonts-gui.AppImage ./share/doc/assfonts/LICENSE ./share/doc/assfonts/NEWS ./share/doc/assfonts/NOTICE ./share/man/man1/assfonts.1.gz
          rm -rf assfonts-${{ github.ref_name }}-aarch64-Linux assfonts-gui-${{ github.ref_name }}-aarch64-Linux.AppImage
          cp -f assfonts-${{ github.ref_name }}-armhf-Linux ./bin/assfonts
          cp -f assfonts-gui-${{ github.ref_name }}-armhf-Linux.AppImage assfonts-gui.AppImage
          tar -czvf assfonts-${{ github.ref_name }}-armhf-Linux.tar.gz bin/assfonts assfonts-gui.AppImage ./share/doc/assfonts/LICENSE ./share/doc/assfonts/NEWS ./share/doc/assfonts/NOTICE ./share/man/man1/assfonts.1.gz
          rm -rf assfonts-${{ github.ref_name }}-armhf-Linux assfonts-gui-${{ github.ref_name }}-armhf-Linux.AppImage
          cp -f assfonts-${{ github.ref_name }}-i686-Linux ./bin/assfonts
          cp -f assfonts-gui-${{ github.ref_name }}-i686-Linux.AppImage assfonts-gui.AppImage
          tar -czvf assfonts-${{ github.ref_name }}-i686-Linux.tar.gz bin/assfonts assfonts-gui.AppImage ./share/doc/assfonts/LICENSE ./share/doc/assfonts/NEWS ./share/doc/assfonts/NOTICE ./share/man/man1/assfonts.1.gz
          rm -rf assfonts-${{ github.ref_name }}-i686-Linux assfonts-gui-${{ github.ref_name }}-i686-Linux.AppImage
          cp -f assfonts-${{ github.ref_name }}-x86_64-Windows.exe assfonts.exe
          cp -f assfonts-gui-${{ github.ref_name }}-x86_64-Windows.exe assfonts-gui.exe
          zip assfonts-${{ github.ref_name }}-x86_64-Windows.zip assfonts.exe assfonts-gui.exe LICENSE.txt NEWS.txt NOTICE.txt README.md
          rm -rf assfonts-${{ github.ref_name }}-x86_64-Windows.exe assfonts-gui-${{ github.ref_name }}-x86_64-Windows.exe
          cp -f assfonts-${{ github.ref_name }}-aarch64-Windows.exe assfonts.exe
          cp -f assfonts-gui-${{ github.ref_name }}-aarch64-Windows.exe assfonts-gui.exe
          zip assfonts-${{ github.ref_name }}-aarch64-Windows.zip assfonts.exe assfonts-gui.exe LICENSE.txt NEWS.txt NOTICE.txt README.md
          rm -rf assfonts-${{ github.ref_name }}-aarch64-Windows.exe assfonts-gui-${{ github.ref_name }}-aarch64-Windows.exe
          cp -f assfonts-${{ github.ref_name }}-i686-Windows.exe assfonts.exe
          cp -f assfonts-gui-${{ github.ref_name }}-i686-Windows.exe assfonts-gui.exe
          zip assfonts-${{ github.ref_name }}-i686-Windows.zip assfonts.exe assfonts-gui.exe LICENSE.txt NEWS.txt NOTICE.txt README.md
          rm -rf assfonts-${{ github.ref_name }}-i686-Windows.exe assfonts-gui-${{ github.ref_name }}-i686-Windows.exe

      - name: calculate hash
        run: |
          sha256sum assfonts-${{ github.ref_name }}-x86_64-Linux.tar.gz > assfonts-${{ github.ref_name }}-x86_64-Linux.tar.gz.sha256sum
          sha256sum assfonts-${{ github.ref_name }}-aarch64-Linux.tar.gz > assfonts-${{ github.ref_name }}-aarch64-Linux.tar.gz.sha256sum
          sha256sum assfonts-${{ github.ref_name }}-armhf-Linux.tar.gz > assfonts-${{ github.ref_name }}-armhf-Linux.tar.gz.sha256sum
          sha256sum assfonts-${{ github.ref_name }}-i686-Linux.tar.gz > assfonts-${{ github.ref_name }}-i686-Linux.tar.gz.sha256sum
          sha256sum assfonts-${{ github.ref_name }}-x86_64-Windows.zip > assfonts-${{ github.ref_name }}-x86_64-Windows.zip.sha256sum
          sha256sum assfonts-${{ github.ref_name }}-aarch64-Windows.zip > assfonts-${{ github.ref_name }}-aarch64-Windows.zip.sha256sum
          sha256sum assfonts-${{ github.ref_name }}-i686-Windows.zip > assfonts-${{ github.ref_name }}-i686-Windows.zip.sha256sum
          sha256sum assfonts-${{ github.ref_name }}-x86_64-macOS.dmg > assfonts-${{ github.ref_name }}-x86_64-macOS.dmg.sha256sum
          sha256sum assfonts-${{ github.ref_name }}-aarch64-macOS.dmg > assfonts-${{ github.ref_name }}-aarch64-macOS.dmg.sha256sum

      - name: edit release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: assfonts-*${{ github.ref_name }}-*
          tag: ${{ github.ref }}
          overwrite: false
          file_glob: true
          
